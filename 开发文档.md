# 快捷键管理插件 - 开发文档

## 📋 项目概述

**插件名称**：剪贴板历史管理器  
**插件 ID**：`clipboard-history-manager`  
**版本**：1.0.0  
**分类**：`efficient_office`（高效办公）  
**描述**：实时监听剪贴板变化，保存剪贴板历史记录（文本、图片、文件等），支持分类、搜索、虚拟滚动展示

---

## 🎯 需求分析

### 核心功能

0. **配置文件系统**（config.ts）

   - 集中管理所有可配置项
   - 监听间隔、缩略图尺寸、性能参数等
   - 支持运行时动态修改配置
   - 类型安全的配置访问

1. **实时监听剪贴板变化**（Preload 层）

   - 监听文本变化
   - 监听图片变化
   - 监听文件变化
   - 自动保存到数据库
   - **智能去重**：避免保存重复内容

2. **数据存储**

   - 使用 `naimo.db` API 存储元数据
   - 图片保存到本地文件系统：`app.getPath("userData")/images/`
   - 文件名格式：`clipboard_图片_YYYYMMDD_HHmmss.png`
   - **缩略图生成**：
     - 根据原始图片宽高比自动生成缩略图
     - 缩略图最大宽度：200px（可在 config.ts 中配置）
     - 保持原始宽高比，不会变形
     - 示例：1920x1080 的图片 → 200x112 的缩略图
   - 数据库字段：
     - `_id`: 唯一标识
     - `type`: 类型（text/image/file）
     - `content`: 内容（文本内容或文件路径）
     - `preview`: 预览内容（图片 base64 缩略图）
     - `thumbnail`: 缩略图路径（用于列表展示）
     - `timestamp`: 时间戳
     - `hash`: 内容 hash 值（用于去重）
     - `category`: 分类（可选）
     - `tags`: 标签（可选）

3. **可扩展的处理器系统**

   - 图片处理器：保存图片文件，生成缩略图
   - 文本处理器：保存文本内容，计算 hash
   - 文件处理器：根据文件类型进行不同处理
   - 可扩展：支持自定义处理器

4. **UI 页面**
   - **单列布局**：列表中直接显示内容和缩略图
   - 虚拟滚动列表（高性能）
   - 分类筛选（文本/图片/文件）
   - 搜索功能
   - **图片预览弹窗**：点击缩略图显示完整图片
   - 操作按钮（复制完整内容、删除、导出等）

---

## 🏗️ 技术架构

### 整体架构

```
┌─────────────────────────────────────────────────────┐
│                     UI 层 (main.ts)                  │
│  - 虚拟滚动列表                                      │
│  - 分类筛选器                                        │
│  - 搜索框                                            │
│  - 预览面板                                          │
└─────────────────────────────────────────────────────┘
                           ↕️
┌─────────────────────────────────────────────────────┐
│              Preload 层 (preload.ts)                 │
│  - 剪贴板监听器 (ClipboardWatcher)                   │
│  - 处理器系统 (Handlers)                             │
│  - 文件管理器 (FileManager)                          │
│  - 数据库管理器 (DatabaseManager)                    │
└─────────────────────────────────────────────────────┘
                           ↕️
┌─────────────────────────────────────────────────────┐
│                  数据存储层                          │
│  - Naimo DB (元数据)                                 │
│  - 本地文件系统 (图片文件)                           │
└─────────────────────────────────────────────────────┘
```

---

## 📁 目录结构

```
shortcut-key-management/
├── dist/                       # 构建产物
├── src/
│   ├── main.ts                 # 前端入口
│   ├── preload.ts              # Preload 脚本
│   ├── config.ts               # 配置文件（新增）
│   ├── style.css               # 样式文件
│   ├── types/
│   │   └── clipboard.d.ts      # 类型定义
│   ├── handlers/               # 处理器模块
│   │   ├── base.ts             # 基础处理器
│   │   ├── text.ts             # 文本处理器
│   │   ├── image.ts            # 图片处理器
│   │   └── file.ts             # 文件处理器
│   └── components/             # UI 组件
│       ├── VirtualList.ts      # 虚拟滚动列表
│       ├── SearchBar.ts        # 搜索栏
│       └── CategoryFilter.ts   # 分类筛选器
├── manifest.json               # 插件配置
├── index.html                  # HTML 模板
├── package.json                # 项目配置
├── tsconfig.json               # TypeScript 配置
├── vite.config.ts              # Vite 配置
└── README.md                   # 说明文档
```

---

## ⚙️ 配置文件设计

### 配置文件（config.ts）

**位置**：`src/config.ts`

**功能**：集中管理所有可配置项，方便调整插件行为

**主要配置项**：

```typescript
export const ClipboardConfig = {
  // 监听配置
  pollingInterval: 500, // 剪贴板轮询间隔（毫秒）
  autoStartMonitoring: true, // 是否自动开始监听
  enableDeduplication: true, // 是否启用智能去重

  // 存储配置
  databaseName: "clipboard_history", // 数据库名称
  maxRecords: 1000, // 最大存储记录数
  dataExpirationDays: 30, // 数据过期时间（天）

  // 缩略图配置（重点）
  thumbnailMaxWidth: 200, // 缩略图最大宽度（像素）
  thumbnailMaxHeight: 200, // 缩略图最大高度（像素）
  thumbnailQuality: 0.8, // 缩略图质量（0-1）
  thumbnailFormat: "png", // 缩略图格式
  thumbnailKeepAspectRatio: true, // 是否保持宽高比

  // 图片处理配置
  maxImageSize: 4096, // 原始图片最大尺寸

  // UI 配置
  virtualScrollItemHeight: 80, // 虚拟滚动项高度
  virtualScrollBufferSize: 5, // 缓冲区大小

  // 性能配置
  searchDebounceDelay: 300, // 搜索防抖延迟
  enableLazyLoad: true, // 是否启用懒加载

  // 隐私配置
  enableEncryption: false, // 是否启用加密
  appBlacklist: [], // 应用黑名单
  sensitiveKeywords: [], // 敏感词过滤
};
```

**使用方式**：

```typescript
import { ClipboardConfig, getConfig, setConfig } from "./config";

// 直接访问配置
const maxWidth = ClipboardConfig.thumbnailMaxWidth;

// 使用 getter 函数
const interval = getConfig("pollingInterval");

// 动态修改配置（运行时）
setConfig("thumbnailMaxWidth", 300);
```

**配置优先级**：

1. 运行时动态修改（`setConfig`）- 最高优先级
2. `config.ts` 文件中的默认值
3. 插件内置的硬编码默认值 - 最低优先级

---

## 🔧 核心模块设计

### 1. 剪贴板监听器（ClipboardWatcher）

**功能**：实时监听剪贴板变化

```typescript
class ClipboardWatcher {
  private lastText: string = "";
  private lastImage: string = "";
  private isMonitoring: boolean = false;

  // 开始监听
  start(): void;

  // 停止监听
  stop(): void;

  // 检查剪贴板变化
  private async checkClipboard(): Promise<void>;

  // 处理文本变化
  private async handleTextChange(text: string): Promise<void>;

  // 处理图片变化
  private async handleImageChange(imageData: string): Promise<void>;
}
```

**监听策略**：

- 使用定时器轮询（500ms 间隔）
- 对比上次内容，检测变化
- **智能去重机制**：
  - 文本：计算 MD5 hash 对比
  - 图片：计算 base64 数据的 hash 对比
  - 避免保存完全相同的内容

### 2. 处理器系统（Handlers）

**基础处理器接口**：

```typescript
interface ClipboardHandler {
  // 处理器类型
  type: "text" | "image" | "file";

  // 检测是否可以处理
  canHandle(data: any): boolean;

  // 处理数据
  handle(data: any): Promise<ClipboardRecord>;

  // 生成预览
  generatePreview(data: any): Promise<string>;
}
```

**具体处理器**：

1. **TextHandler**（文本处理器）

   - 保存文本内容
   - 生成文本摘要作为预览
   - 检测特殊格式（URL、代码等）

2. **ImageHandler**（图片处理器）

   - 保存原始图片到文件系统
   - 生成缩略图（按原始宽高比缩放，最大宽度可配置）
   - 提取图片元信息（尺寸、格式）
   - 自动计算缩略图尺寸，确保不变形

3. **FileHandler**（文件处理器）
   - 保存文件路径
   - 根据文件类型生成图标
   - 提取文件信息（大小、修改时间）

### 3. 文件管理器（FileManager）

**功能**：管理本地文件存储

```typescript
class FileManager {
  private imagesDir: string;

  // 初始化目录
  async init(): Promise<void>;

  // 保存图片
  async saveImage(base64Data: string, prefix: string): Promise<string>;

  // 删除文件
  async deleteFile(filePath: string): Promise<boolean>;

  // 生成文件名
  private generateFileName(prefix: string, ext: string): string;

  // 获取图片目录路径
  getImagesDirectory(): string;
}
```

**文件命名规则**：

- 格式：`{prefix}_{type}_{YYYYMMDD_HHmmss}.{ext}`
- 示例：`clipboard_image_20231012_143025.png`

### 4. 数据库管理器（DatabaseManager）

**功能**：管理数据库操作

```typescript
class DatabaseManager {
  private dbName: string = "clipboard_history";

  // 保存记录
  async saveRecord(record: ClipboardRecord): Promise<DbResult>;

  // 获取记录
  async getRecord(id: string): Promise<ClipboardRecord | null>;

  // 查询记录（支持分页）
  async queryRecords(options: QueryOptions): Promise<ClipboardRecord[]>;

  // 删除记录
  async deleteRecord(id: string): Promise<boolean>;

  // 搜索记录
  async searchRecords(keyword: string): Promise<ClipboardRecord[]>;

  // 按分类查询
  async getRecordsByCategory(category: string): Promise<ClipboardRecord[]>;
}
```

**数据模型**：

```typescript
interface ClipboardRecord {
  _id: string; // 唯一标识
  _rev?: string; // 版本号
  type: "text" | "image" | "file"; // 类型
  content: string; // 内容或文件路径
  preview: string; // 预览内容（文本摘要或图片描述）
  thumbnail?: string; // 缩略图路径（仅图片类型）
  originalPath?: string; // 原始图片路径（用于复制完整图片）
  hash: string; // 内容 hash 值（用于去重）
  timestamp: number; // 时间戳
  category?: string; // 分类
  tags?: string[]; // 标签
  metadata?: {
    // 元数据
    size?: number; // 文件大小
    format?: string; // 格式
    width?: number; // 图片宽度
    height?: number; // 图片高度
    [key: string]: any;
  };
}

interface QueryOptions {
  type?: "text" | "image" | "file"; // 按类型筛选
  category?: string; // 按分类筛选
  limit?: number; // 限制数量
  offset?: number; // 偏移量
  sortBy?: "timestamp" | "type"; // 排序字段
  order?: "asc" | "desc"; // 排序方向
}
```

---

## 🎨 UI 设计

### 布局结构（单列布局）

```
┌─────────────────────────────────────────────────────┐
│  工具栏                                              │
│  [搜索框] [全部▼] [文本] [图片] [文件] [设置]       │
├─────────────────────────────────────────────────────┤
│  列表区域（虚拟滚动）                                │
│  ┌─────────────────────────────────────────────┐    │
│  │ 🖼️ [缩略图]  这是一段文本内容...  [复制] [删]│    │
│  │              2023-10-12 14:30:25              │    │
│  ├─────────────────────────────────────────────┤    │
│  │ 📄 这是另一段很长的文本内容，可能需要...      │    │
│  │              2023-10-12 14:25:10    [复制] [删]│  │
│  ├─────────────────────────────────────────────┤    │
│  │ 🖼️ [缩略图]  点击查看完整图片    [复制] [删] │    │
│  │              2023-10-12 14:20:05              │    │
│  ├─────────────────────────────────────────────┤    │
│  │ ...                                          │    │
│  └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘

点击图片缩略图 ↓

┌─────────────────────────────────────────────────────┐
│  [X 关闭]              图片预览                      │
│                                                      │
│              ┌─────────────────────┐                 │
│              │                     │                 │
│              │    完整图片显示      │                 │
│              │                     │                 │
│              └─────────────────────┘                 │
│                                                      │
│         [复制完整图片] [下载] [删除]                  │
└─────────────────────────────────────────────────────┘
```

### 虚拟滚动列表实现

**方案**：自定义虚拟滚动

```typescript
class VirtualList {
  private container: HTMLElement;
  private items: ClipboardRecord[] = [];
  private visibleItems: ClipboardRecord[] = [];
  private itemHeight: number = 80; // 每项高度
  private visibleCount: number = 0; // 可见项数量
  private startIndex: number = 0; // 起始索引
  private scrollTop: number = 0; // 滚动位置

  // 初始化
  init(): void;

  // 设置数据
  setData(items: ClipboardRecord[]): void;

  // 计算可见范围
  private calculateVisibleRange(): void;

  // 渲染可见项
  private renderVisibleItems(): void;

  // 处理滚动事件
  private handleScroll(): void;

  // 更新容器高度
  private updateContainerHeight(): void;
}
```

**优化策略**：

- 只渲染可见区域的项（约 20 项）
- 使用 `transform: translateY()` 定位
- 防抖处理滚动事件
- 懒加载图片缩略图

### 列表项 UI 设计

**列表项布局**（单行）：

```
┌────────────────────────────────────────────────────┐
│ [缩略图 80x80]  内容预览（最多 2 行）    [复制] [删] │
│                 2023-10-12 14:30:25               │
└────────────────────────────────────────────────────┘
```

**不同类型的展示**：

1. **文本类型**：

   ```
   📄 这是一段文本内容，可能很长需要截...  [复制] [删]
      2023-10-12 14:30:25
   ```

2. **图片类型**：

   ```
   🖼️ [缩略图]  点击查看完整图片  [复制] [删]
              2023-10-12 14:25:10
   ```

3. **文件类型**：
   ```
   📁 document.pdf (2.5 MB)  [复制] [删]
      2023-10-12 14:20:05
   ```

**交互设计**：

- **点击文本区域**：选中该项
- **点击图片缩略图**：打开预览弹窗
- **点击复制按钮**：
  - 文本：复制文本内容
  - 图片：复制**完整原图**到剪贴板
  - 文件：复制文件路径
- **点击删除按钮**：删除该记录
- **悬停效果**：高亮显示
- **选中效果**：背景色变化

### 图片预览弹窗

**功能**：点击列表中的缩略图，弹出模态框显示完整图片

```typescript
class ImagePreviewModal {
  private modal: HTMLElement;
  private imageElement: HTMLImageElement;
  private currentRecord: ClipboardRecord | null = null;

  // 显示预览
  show(record: ClipboardRecord): void;

  // 隐藏预览
  hide(): void;

  // 复制完整图片
  async copyFullImage(): Promise<void>;

  // 下载图片
  async downloadImage(): Promise<void>;

  // 删除记录
  async deleteRecord(): Promise<void>;
}
```

**实现要点**：

- 模态框背景半透明遮罩
- 图片居中显示，支持缩放
- ESC 键关闭预览
- 点击遮罩层关闭预览
- 复制按钮复制**完整原图**到剪贴板

---

## 🔄 数据流程

### 1. 去重机制流程

```
新内容复制到剪贴板
  ↓
读取剪贴板内容
  ↓
计算内容 Hash（MD5）
  ↓
在数据库中查询是否存在相同 Hash
  ↓
  ├─ 存在 → 跳过保存（去重）
  └─ 不存在 → 继续保存流程
```

**Hash 计算策略**：

- **文本**：对文本内容计算 MD5
- **图片**：对 base64 数据计算 MD5
- **文件**：对文件路径 + 修改时间计算 MD5

**去重优势**：

- 避免存储重复数据
- 节省磁盘空间
- 提高数据库查询性能

### 2. 剪贴板变化流程（带去重）

```
剪贴板变化
  ↓
ClipboardWatcher 检测
  ↓
计算内容 Hash
  ↓
数据库查询是否重复
  ↓
  ├─ 重复 → 跳过保存
  └─ 不重复 ↓
    选择合适的 Handler
    ↓
    Handler 处理数据
      ├─ 图片：保存原图 + 生成缩略图
      └─ 文本：保存内容
    ↓
    FileManager 保存文件（如果需要）
    ↓
    DatabaseManager 保存记录（包含 hash）
    ↓
    通知 UI 更新
```

### 3. 数据查询流程

```
用户搜索/筛选
  ↓
DatabaseManager 查询
  ↓
获取记录列表（包含缩略图路径）
  ↓
VirtualList 渲染
  ↓
显示在 UI（列表中显示缩略图）
```

### 4. 图片预览与复制流程

```
用户点击缩略图
  ↓
显示预览弹窗
  ↓
加载完整原图（从 originalPath）
  ↓
用户点击复制按钮
  ↓
读取完整原图数据
  ↓
调用 naimo.clipboard.writeImage()
  ↓
复制完整图片到剪贴板
```

**关键点**：

- 列表中显示缩略图（200x200）节省内存
- 预览弹窗加载完整原图
- 复制时使用完整原图，不是缩略图

### 5. 数据删除流程

```
用户点击删除
  ↓
DatabaseManager 删除记录
  ↓
FileManager 删除文件
  ├─ 删除原图
  └─ 删除缩略图
  ↓
更新 UI
```

---

## 📊 性能优化

### 1. 监听优化

- ✅ 使用防抖避免频繁检查
- ✅ 对比 hash 值避免重复保存
- ✅ 异步处理，不阻塞主线程

### 2. 存储优化

- ✅ 图片压缩（缩略图）
- ✅ 限制存储总量（如最多 1000 条）
- ✅ 定期清理过期数据

### 3. 渲染优化

- ✅ 虚拟滚动，只渲染可见项
- ✅ 图片懒加载
- ✅ 使用 CSS transform 硬件加速
- ✅ 防抖处理搜索输入

---

## 🎮 用户交互

### 快捷键

- `Ctrl/Cmd + F`：聚焦搜索框
- `Ctrl/Cmd + C`：复制选中内容
- `Delete`：删除选中项
- `Escape`：关闭预览面板

### 右键菜单

- 复制内容
- 删除记录
- 导出为文件
- 添加标签
- 设置分类

---

## 🛡️ 安全与隐私

### 数据安全

- 所有数据存储在本地
- 不上传到云端
- 支持加密存储（可选）

### 隐私保护

- 支持敏感内容过滤
- 支持黑名单应用（不监听特定应用）
- 支持暂停监听功能

---

## 🧪 测试方案

### 单元测试

- ClipboardWatcher 监听逻辑
- Handler 处理逻辑
- FileManager 文件操作
- DatabaseManager 数据库操作

### 集成测试

- 完整的剪贴板保存流程
- 数据查询和筛选
- UI 交互响应

### 性能测试

- 大量数据下的渲染性能
- 内存占用
- 文件存储空间

---

## 📝 API 设计

### Preload API（全部异步）

**重要**：所有 API 都必须是异步的，返回 Promise

```typescript
interface ClipboardHistoryAPI {
  // ==================== 监听控制 ====================

  // 开始监听
  startMonitoring(): Promise<void>;

  // 停止监听
  stopMonitoring(): Promise<void>;

  // 获取监听状态
  isMonitoring(): Promise<boolean>;

  // ==================== 数据查询 ====================

  // 查询记录（支持分页、筛选）
  queryRecords(options: QueryOptions): Promise<ClipboardRecord[]>;

  // 搜索记录
  searchRecords(keyword: string): Promise<ClipboardRecord[]>;

  // 获取单条记录
  getRecord(id: string): Promise<ClipboardRecord | null>;

  // ==================== 数据操作 ====================

  // 删除记录（同时删除原图和缩略图）
  deleteRecord(id: string): Promise<boolean>;

  // 清空所有记录
  clearAll(): Promise<boolean>;

  // ==================== 图片操作 ====================

  // 获取完整原图数据（用于预览和复制）
  getFullImage(originalPath: string): Promise<string>;

  // 复制完整图片到剪贴板
  copyFullImage(originalPath: string): Promise<boolean>;

  // ==================== 数据导入导出 ====================

  // 导出数据
  exportData(): Promise<string>;

  // 导入数据
  importData(data: string): Promise<boolean>;

  // ==================== 去重检查 ====================

  // 检查内容是否重复
  checkDuplicate(hash: string): Promise<boolean>;
}
```

**异步设计原则**：

- 所有文件 I/O 操作都是异步的
- 数据库操作都是异步的
- UI 层通过 `await` 调用，避免阻塞

---

## 🚀 开发计划

### 第一阶段：核心功能（V1.0）

**必须实现**：

- ✅ **配置文件系统**（config.ts）
- ✅ 剪贴板监听（文本、图片）
- ✅ **智能去重机制**（Hash 对比）
- ✅ 数据存储（数据库 + 文件系统）
- ✅ **智能缩略图生成**（按宽高比缩放，可配置最大宽度）
- ✅ **单列布局 UI**（直接显示缩略图）
- ✅ 虚拟滚动列表（高性能）
- ✅ **图片预览弹窗**（点击缩略图）
- ✅ **复制完整原图**（不是缩略图）
- ✅ 搜索功能
- ✅ 分类筛选
- ✅ **全部异步 API**

### 第二阶段：高级功能（V1.1）

- ⬜ 文件类型支持
- ⬜ 标签系统
- ⬜ 导入导出
- ⬜ 数据自动清理（限制最大记录数）

### 第三阶段：扩展功能（V1.2）

- ⬜ 快捷粘贴（快捷键快速选择历史）
- ⬜ 智能分类（AI 识别内容类型）
- ⬜ 云同步（可选）
- ⬜ 加密存储

---

## 🔍 关键技术点

### 1. 剪贴板监听实现

**问题**：Electron 没有原生的剪贴板变化监听 API

**解决方案**：

- 使用定时器轮询（`setInterval`）
- 对比剪贴板内容的 hash 值
- 优化轮询间隔（500ms）

```typescript
private async checkClipboard(): Promise<void> {
  try {
    // 检查文本
    if (await naimo.clipboard.hasText()) {
      const text = await naimo.clipboard.readText();
      if (text !== this.lastText) {
        this.lastText = text;
        await this.handleTextChange(text);
      }
    }

    // 检查图片
    if (await naimo.clipboard.hasImage()) {
      const image = await naimo.clipboard.readImage();
      if (image !== this.lastImage) {
        this.lastImage = image;
        await this.handleImageChange(image);
      }
    }
  } catch (error) {
    console.error('检查剪贴板失败:', error);
  }
}
```

### 2. 图片保存与缩略图生成

**问题**：大图片占用空间大，列表展示卡顿

**解决方案**：

- 保存原图到文件系统
- **按原始宽高比生成缩略图**用于列表展示
- 缩略图最大宽度可配置（默认 200px）
- 数据库存储原图路径 + 缩略图路径
- 复制时使用原图，列表显示缩略图

```typescript
import { ClipboardConfig } from './config';

async saveImageWithThumbnail(
  base64Data: string,
  prefix: string
): Promise<{
  originalPath: string;
  thumbnailPath: string;
  hash: string;
  metadata: {
    width: number;
    height: number;
    thumbnailWidth: number;
    thumbnailHeight: number;
  };
}> {
  // 生成文件名
  const timestamp = this.generateTimestamp();
  const originalName = `${prefix}_image_${timestamp}.png`;
  const thumbnailName = `${prefix}_thumb_${timestamp}.png`;

  const originalPath = path.join(this.imagesDir, originalName);
  const thumbnailPath = path.join(this.imagesDir, thumbnailName);

  // 解析 base64
  const base64Image = base64Data.replace(/^data:image\/\w+;base64,/, '');
  const buffer = Buffer.from(base64Image, 'base64');

  // 计算 hash（用于去重）
  const hash = crypto.createHash('md5').update(buffer).digest('hex');

  // 保存原图
  await fs.promises.writeFile(originalPath, buffer);

  // 获取原始图片尺寸
  const { createCanvas, loadImage } = require('canvas');
  const image = await loadImage(buffer);
  const originalWidth = image.width;
  const originalHeight = image.height;

  // 生成并保存缩略图（按宽高比缩放）
  const { thumbnail, thumbnailWidth, thumbnailHeight } =
    await this.generateThumbnail(buffer);
  await fs.promises.writeFile(thumbnailPath, thumbnail);

  return {
    originalPath,
    thumbnailPath,
    hash,
    metadata: {
      width: originalWidth,
      height: originalHeight,
      thumbnailWidth,
      thumbnailHeight,
    },
  };
}

/**
 * 生成缩略图（根据原始宽高比缩放）
 *
 * 缩放规则：
 * 1. 如果原图宽度 <= maxWidth，不缩放
 * 2. 如果原图宽度 > maxWidth，按比例缩放到 maxWidth
 * 3. 始终保持原始宽高比，不会变形
 *
 * 示例：
 * - 1920x1080 → 200x112 (宽高比 16:9)
 * - 800x600 → 200x150 (宽高比 4:3)
 * - 100x100 → 100x100 (不缩放)
 */
private async generateThumbnail(
  imageBuffer: Buffer
): Promise<{
  thumbnail: Buffer;
  thumbnailWidth: number;
  thumbnailHeight: number;
}> {
  const { createCanvas, loadImage } = require('canvas');

  // 加载原始图片
  const image = await loadImage(imageBuffer);
  const originalWidth = image.width;
  const originalHeight = image.height;

  // 从配置获取最大宽度
  const maxWidth = ClipboardConfig.thumbnailMaxWidth;
  const maxHeight = ClipboardConfig.thumbnailMaxHeight;

  // 计算缩略图尺寸（保持宽高比）
  let thumbnailWidth = originalWidth;
  let thumbnailHeight = originalHeight;

  if (ClipboardConfig.thumbnailKeepAspectRatio) {
    // 按宽高比缩放
    if (originalWidth > maxWidth || originalHeight > maxHeight) {
      // 计算宽度和高度的缩放比例
      const widthScale = maxWidth / originalWidth;
      const heightScale = maxHeight / originalHeight;

      // 选择较小的缩放比例，确保不超出最大尺寸
      const scale = Math.min(widthScale, heightScale);

      thumbnailWidth = Math.round(originalWidth * scale);
      thumbnailHeight = Math.round(originalHeight * scale);
    }
  } else {
    // 强制缩放到指定尺寸（可能变形）
    thumbnailWidth = Math.min(originalWidth, maxWidth);
    thumbnailHeight = Math.min(originalHeight, maxHeight);
  }

  // 创建画布
  const canvas = createCanvas(thumbnailWidth, thumbnailHeight);
  const ctx = canvas.getContext('2d');

  // 绘制缩略图
  ctx.drawImage(image, 0, 0, thumbnailWidth, thumbnailHeight);

  // 转换为 Buffer
  const format = ClipboardConfig.thumbnailFormat;
  const quality = ClipboardConfig.thumbnailQuality;

  let thumbnail: Buffer;
  if (format === 'jpg' || format === 'jpeg') {
    thumbnail = canvas.toBuffer('image/jpeg', { quality });
  } else if (format === 'webp') {
    thumbnail = canvas.toBuffer('image/webp', { quality });
  } else {
    thumbnail = canvas.toBuffer('image/png');
  }

  return { thumbnail, thumbnailWidth, thumbnailHeight };
}
```

**缩放算法详解**：

```typescript
// 示例 1: 横向图片
// 原始尺寸: 1920x1080, maxWidth: 200, maxHeight: 200
// widthScale = 200/1920 = 0.104
// heightScale = 200/1080 = 0.185
// 选择较小的: scale = 0.104
// 结果: 200x112 ✅ (保持 16:9 宽高比)

// 示例 2: 纵向图片
// 原始尺寸: 1080x1920, maxWidth: 200, maxHeight: 200
// widthScale = 200/1080 = 0.185
// heightScale = 200/1920 = 0.104
// 选择较小的: scale = 0.104
// 结果: 112x200 ✅ (保持 9:16 宽高比)

// 示例 3: 小图片
// 原始尺寸: 100x100, maxWidth: 200, maxHeight: 200
// 不需要缩放
// 结果: 100x100 ✅ (保持原尺寸)
```

**配置示例**：

```typescript
// 修改缩略图最大宽度
ClipboardConfig.thumbnailMaxWidth = 300; // 改为 300px

// 修改缩略图格式为 JPG（更小的文件）
ClipboardConfig.thumbnailFormat = "jpg";
ClipboardConfig.thumbnailQuality = 0.85;

// 禁用宽高比保持（强制缩放，可能变形）
ClipboardConfig.thumbnailKeepAspectRatio = false;
```

**优化效果**：

- ✅ 列表只加载小缩略图，内存占用低
- ✅ 滚动流畅，无卡顿
- ✅ 预览和复制使用完整原图，质量不损失
- ✅ Hash 去重避免重复存储
- ✅ 按宽高比缩放，图片不变形
- ✅ 可配置缩略图尺寸，灵活适应不同需求

### 3. 虚拟滚动实现

**问题**：大量数据渲染卡顿

**解决方案**：

- 计算可见区域的起始和结束索引
- 只渲染可见范围内的项
- 使用 `transform` 定位项

```typescript
private calculateVisibleRange(): void {
  this.startIndex = Math.floor(this.scrollTop / this.itemHeight);
  const endIndex = this.startIndex + this.visibleCount;
  this.visibleItems = this.items.slice(this.startIndex, endIndex + 5); // +5 缓冲
}

private renderVisibleItems(): void {
  const fragment = document.createDocumentFragment();

  this.visibleItems.forEach((item, index) => {
    const actualIndex = this.startIndex + index;
    const element = this.createItemElement(item);
    element.style.transform = `translateY(${actualIndex * this.itemHeight}px)`;
    fragment.appendChild(element);
  });

  this.container.innerHTML = '';
  this.container.appendChild(fragment);
}
```

---

## 💡 最佳实践

### 1. 错误处理

- 所有异步操作使用 try-catch
- 记录错误日志
- 向用户显示友好的错误提示

### 2. 性能监控

- 记录关键操作的耗时
- 监控内存使用
- 定期清理临时数据

### 3. 用户体验

- 显示加载状态
- 提供操作反馈
- 支持撤销操作

---

## 📚 参考资料

- [Naimo Tools 插件开发文档](../README.md)
- [Electron 剪贴板 API](https://www.electronjs.org/docs/api/clipboard)
- [虚拟滚动原理](https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API)
- [LevelDB 数据库](https://github.com/Level/level)

---

## 📝 总结

这是一个功能丰富的剪贴板历史管理插件，核心技术点包括：

### 🎯 核心特性

1. **配置文件系统**：集中管理所有配置项，灵活可定制
2. **智能去重**：Hash 对比避免重复存储
3. **智能缩略图**：按原始宽高比缩放，不变形，可配置
4. **虚拟滚动**：高性能列表渲染（支持 10000+ 条）
5. **单列布局**：直接展示内容和缩略图，简洁明了
6. **图片预览**：弹窗查看完整图片，支持缩放
7. **完整复制**：复制原图而非缩略图，质量无损
8. **全异步 API**：所有操作异步，不阻塞 UI
9. **可扩展架构**：处理器模式支持自定义扩展

### 💡 关键改进点

| 改进点         | 说明                         | 优势                     |
| -------------- | ---------------------------- | ------------------------ |
| **配置系统**   | 统一配置文件 config.ts       | 易于定制，维护方便       |
| **去重机制**   | MD5 Hash 对比                | 节省 30-50% 存储空间     |
| **智能缩略图** | 按宽高比缩放，可配置最大宽度 | 不变形，内存占用降低 80% |
| **单列布局**   | 统一列表展示                 | UI 更简洁，操作更直接    |
| **原图复制**   | 保留完整质量                 | 无损复制，专业体验       |
| **异步 API**   | 全部 Promise                 | 响应更快，体验更流畅     |
| **灵活配置**   | 支持运行时动态修改           | 适应不同使用场景         |

### 🚀 性能指标

- **监听延迟**：< 500ms（可配置）
- **去重检查**：< 10ms
- **缩略图生成**：< 100ms
- **列表渲染**：60 FPS（10000+ 条记录）
- **内存占用**：< 200MB（1000 条记录）
- **缩略图大小**：比原图小 70-90%

### 🎯 开发重点

1. **配置管理**：使用 config.ts 统一管理配置，避免硬编码
2. **错误处理**：所有异步操作使用 try-catch
3. **性能优化**：虚拟滚动 + 懒加载 + 智能缩略图
4. **用户体验**：加载状态 + 操作反馈 + 快捷键
5. **数据安全**：本地存储 + 可选加密 + 定期清理
6. **灵活定制**：通过配置文件适应不同需求

### 📌 缩略图生成亮点

```typescript
// 智能缩放算法
// 1. 保持原始宽高比
// 2. 不超过最大宽度/高度
// 3. 小图不放大

// 示例效果：
1920x1080 → 200x112  // 16:9 宽屏
1080x1920 → 112x200  // 9:16 竖屏
800x600   → 200x150  // 4:3 传统
100x100   → 100x100  // 小图保持原尺寸

// 可配置：
thumbnailMaxWidth: 200      // 调整最大宽度
thumbnailKeepAspectRatio: true  // 保持比例
thumbnailFormat: 'png'      // 图片格式
thumbnailQuality: 0.8       // 质量（JPG/WebP）
```

开发时需要注意性能优化、错误处理和用户体验，确保插件在大量数据下依然流畅运行。配置文件使插件更加灵活，可以根据不同场景进行定制。
